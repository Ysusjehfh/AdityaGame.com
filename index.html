<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Space Dodge ‚Äî Power-Ups Merged</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#071022;color:#fff;font-family:system-ui,Segoe UI,Roboto;display:flex;justify-content:center;padding:12px}
.app{width:100%;max-width:420px;position:relative}
h3{margin:8px 0}
.row{margin:8px 0}
button{width:100%;padding:10px;border-radius:12px;border:2px solid #7c3aed;background:transparent;color:#fff;font-weight:700;margin-top:8px;transition:.2s}
button:active{transform:scale(.92);background:#7c3aed33}
.small{font-size:13px;color:#cbd5e1}
select,input{width:100%;padding:8px;border-radius:10px;border:1px solid #334155;background:transparent;color:#fff}
.store,.redeem,.mapSelect,.rocketSelect{background:#0e162a;padding:10px;border-radius:12px;margin-top:10px}
.item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;border:1px solid #2b3440;margin-top:8px}
.item button{width:auto;padding:6px 10px}
canvas{width:100%;height:520px;border-radius:12px;display:none;margin-top:10px;background:#000;touch-action:none;}
.hud{display:flex;justify-content:space-between;margin-top:8px;font-weight:700}
.ctrl{display:none;justify-content:center;gap:12px;margin-top:10px}
.ctrl button{width:70px;height:70px;border-radius:12px;font-size:20px}
.note{font-size:12px;color:#9aa4b2;margin-top:6px}

/* Game Over overlay */
#gameOver {
  position:absolute;
  inset:0;
  display:none;
  background:rgba(0,0,0,0.8);
  backdrop-filter: blur(3px);
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:12px;
  z-index:20;
  border-radius:12px;
  padding:20px;
  text-align:center;
  color:#fff;
}
#gameOver h2{font-size:28px;margin:0}
#gameOver p{margin:0;color:#d1d5db}
#gameOver .go-btn{width:180px;padding:10px;border-radius:10px}

.power-label {
  position: absolute;
  left: 12px;
  top: 12px;
  font-size: 13px;
  color: #cbd5e1;
}
.power-active {
  display:inline-block;
  margin-left:8px;
  font-weight:700;
}
</style>
</head>
<body>
<div class="app">
  <div class="power-label">Active:
    <span id="activePowers" class="power-active">None</span>
  </div>

  <!-- Game Over Overlay -->
  <div id="gameOver" role="dialog" aria-hidden="true" aria-modal="true">
    <h2>üí• Game Over</h2>
    <p id="goScore">Score: 0</p>
    <p id="goCoins">Coins Earned: 0</p>
    <div style="width:220px">
      <button class="go-btn" id="playAgain">Play Again</button>
      <button class="go-btn" id="backMenu" style="margin-top:8px">Back to Menu</button>
    </div>
  </div>

  <!-- Menu -->
  <div id="menu">
    <div class="mapSelect">
      <h4>üó∫Ô∏è Select Map</h4>
      <select id="mapChoice"></select>
    </div>

    <div class="rocketSelect">
      <h4>üöÄ Select Rocket</h4>
      <select id="rocketChoice"></select>
      <div class="note">Only one rocket can be active at a time</div>
    </div>

    <h3>Select Difficulty</h3>
    <div class="row">
      <button onclick="setDiff(1)">Normal</button>
      <button onclick="setDiff(2)">Medium</button>
      <button onclick="setDiff(3)">Hard</button>
      <button onclick="setDiff(4)">üî• Extreme</button>
    </div>

    <p class="small">Total Coins ü™ô <span id="menuCoins">0</span></p>

    <div class="store" id="storeContainer">
      <h4>üõí Store</h4>
      <div id="storeItems"></div>
    </div>

    <div class="redeem">
      <h4>üéÅ Redeem Code</h4>
      <input id="codeInput" placeholder="Enter Code">
      <button onclick="redeemCode()">Redeem</button>
      <div class="note">Codes are one-time use per device (saved locally).</div>
    </div>
  </div>

  <!-- Game UI -->
  <div id="gameUI">
    <div class="hud">
      <div id="score">Score: 0</div>
      <div>ü™ô <span id="coins">0</span></div>
    </div>
    <canvas id="gameCanvas" width="720" height="1040" aria-label="Game canvas"></canvas>

    <div class="ctrl" id="ctrl">
      <button id="leftBtn" aria-label="Left">‚óÄ</button>
      <button id="rightBtn" aria-label="Right">‚ñ∂</button>
    </div>
  </div>
</div>

<script>
/* ===========================
   Core elements & variables
   =========================== */
const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
const W = 360, H = 520;

let rockets = [
  {type:'rocket1', multiplier:2, owned:false, color:'#7c3aed'},
  {type:'rocket2', multiplier:3, owned:false, color:'#22c55e'}
];
let selectedRocket = 'rocket1';

let px = W/2, py = 450, moveDir = 0;
let asteroids = [], coinsArr = [];
let score = 0, play = false, lastScoreCoinBonus = 0;
let totalCoins = localStorage.getItem('TOTAL_COINS') ? +localStorage.getItem('TOTAL_COINS') : 0;
let startCoins = totalCoins; // coins when the run started (for Game Over earned display)

rockets.forEach(r => r.owned = localStorage.getItem('OWN_' + r.type) === '1');

const maps = [
  {id:'space', name:'Space', price:0},
  {id:'nebula', name:'Nebula', price:80},
  {id:'mars', name:'Mars', price:100},
  {id:'jupiter', name:'Jupiter', price:120},
  {id:'galaxy', name:'Galaxy', price:150},
  {id:'blackhole', name:'Blackhole', price:200}
];

const menu = document.getElementById('menu');
const menuCoins = document.getElementById('menuCoins');
const coinsEl = document.getElementById('coins');
const mapChoice = document.getElementById('mapChoice');
const rocketChoice = document.getElementById('rocketChoice');
const storeItems = document.getElementById('storeItems');
const ctrl = document.getElementById('ctrl');
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');

const gameOverEl = document.getElementById('gameOver');
const goScore = document.getElementById('goScore');
const goCoins = document.getElementById('goCoins');
const playAgainBtn = document.getElementById('playAgain');
const backMenuBtn = document.getElementById('backMenu');

const activePowersEl = document.getElementById('activePowers');

menuCoins.innerText = coinsEl.innerText = totalCoins;

/* ===========================
   Power-up system variables
   =========================== */
// falling on-screen power-ups
let powerUps = []; // {type:'shield'|'magnet'|'slow', x, y, vy, taken:false}
// power effect states
let shieldActive = false, magnetActive = false, slowActive = false;
let shieldExpires = 0, magnetExpires = 0, slowExpires = 0;

// durations (ms)
const DURATION = {
  shield: 6000,
  magnet: 6000,
  slow: 5000
};

// store original values to restore after slow
let originalEnemySpeed = null, originalSpawnRate = null;

// spawn control: every 500 points
let lastPowerSpawnScore = 0;

/* ===========================
   Menu / Store / Redeem
   =========================== */
function populateMenu(){
  mapChoice.innerHTML = '';
  maps.forEach(m => {
    const unlocked = localStorage.getItem('MAP_' + m.id) === '1' || m.price === 0;
    const opt = document.createElement('option');
    opt.value = m.id;
    opt.text = m.name + (m.price > 0 ? (unlocked ? ' (Unlocked)' : ` (Locked ${m.price}ü™ô)`) : ' (Free)');
    mapChoice.appendChild(opt);
  });

  rocketChoice.innerHTML = '';
  rockets.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.type;
    opt.text = r.type === 'rocket1' ? 'Rocket 1 (2x coins)' : 'Rocket 2 (3x coins)';
    rocketChoice.appendChild(opt);
  });

  storeItems.innerHTML = '';
  maps.forEach(m => {
    if(m.price > 0){
      const unlocked = localStorage.getItem('MAP_' + m.id) === '1';
      const div = document.createElement('div');
      div.className = 'item';
      if(unlocked) div.innerHTML = `<span>${m.name} Map (Unlocked)</span>`;
      else div.innerHTML = `<span>${m.name} Map</span><button onclick="buyMap('${m.id}',${m.price})">ü™ô ${m.price}</button>`;
      storeItems.appendChild(div);
    }
  });

  rockets.forEach(r => {
    if(!r.owned){
      const price = r.type === 'rocket1' ? 500 : 1000;
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<span>üöÄ ${r.type === 'rocket1' ? 'Rocket 1' : 'Rocket 2'}</span><button onclick="buyRocket('${r.type}',${price})">ü™ô ${price}</button>`;
      storeItems.appendChild(div);
    }
  });
}
populateMenu();

function buyRocket(type, price){
  if(totalCoins < price) return alert('Not enough coins');
  totalCoins -= price;
  if(totalCoins < 0) totalCoins = 0;
  const r = rockets.find(x => x.type === type); r.owned = true;
  localStorage.setItem('TOTAL_COINS', totalCoins);
  localStorage.setItem('OWN_' + type, '1');
  alert('‚úÖ ' + (type === 'rocket1' ? 'Rocket 1' : 'Rocket 2') + ' unlocked!');
  updateCoinsUI();
  populateMenu();
}

function buyMap(id, price){
  if(localStorage.getItem('MAP_' + id) === '1') return alert('Already unlocked');
  if(totalCoins < price) return alert('Not enough coins');
  totalCoins -= price;
  if(totalCoins < 0) totalCoins = 0;
  localStorage.setItem('TOTAL_COINS', totalCoins);
  localStorage.setItem('MAP_' + id, '1');
  alert('‚úÖ ' + maps.find(m => m.id === id).name + ' unlocked');
  updateCoinsUI();
  populateMenu();
}

const validCodes = {
  "WELCOME50":50,
  "SUPER100":100,
  "BOOST25":25,
  "DEVELOPERADITYA":1000,
  "SATYAMNOOB":2000
};

function redeemCode(){
  const raw = document.getElementById('codeInput').value || '';
  const code = raw.trim().toUpperCase();
  if(!code) return alert('Enter a code');
  if(!validCodes[code]) return alert('Invalid code');
  if(localStorage.getItem('USED_' + code)) return alert('Code already used');
  totalCoins += validCodes[code];
  localStorage.setItem('TOTAL_COINS', totalCoins);
  localStorage.setItem('USED_' + code, '1');
  alert('üéâ Code redeemed: +' + validCodes[code] + ' coins');
  document.getElementById('codeInput').value = '';
  updateCoinsUI();
  populateMenu();
}

function updateCoinsUI(){
  if(totalCoins < 0) totalCoins = 0;
  menuCoins.innerText = coinsEl.innerText = totalCoins;
  updateActivePowersLabel();
}

/* ===========================
   Controls (touch + mouse + drag)
   =========================== */
[leftBtn, rightBtn].forEach((btn, i) => {
  const dir = i === 0 ? -1 : 1;
  btn.addEventListener('touchstart', e => { e.preventDefault(); moveDir = dir; });
  btn.addEventListener('touchend', () => moveDir = 0);
  btn.addEventListener('mousedown', (e) => { e.preventDefault(); moveDir = dir; });
  btn.addEventListener('mouseup', () => moveDir = 0);
  btn.addEventListener('mouseleave', () => moveDir = 0);
});

// drag-to-move for touch
canvas.addEventListener('touchmove', e => {
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  const x = (t.clientX - rect.left) * (W / rect.width);
  px = Math.max(20, Math.min(W - 20, x));
});

// keyboard controls for desktop
let keys = {};
window.addEventListener('keydown', (e) => {
  keys[e.key] = true;
  if(e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') moveDir = -1;
  if(e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') moveDir = 1;
});
window.addEventListener('keyup', (e) => {
  keys[e.key] = false;
  if(!keys['ArrowLeft'] && !keys['a'] && !keys['A'] && !keys['ArrowRight'] && !keys['d'] && !keys['D']) moveDir = 0;
});

/* ===========================
   Difficulty & start
   =========================== */
let spawnRate = 0.02, enemySpeed = 3, scoreSpeed = 1, coinRate = 0.01;
let selectedMap = 'space';

function setDiff(l){
  if(l===1){ spawnRate=.02; enemySpeed=3; scoreSpeed=1; coinRate=.01; }
  if(l===2){ spawnRate=.035; enemySpeed=4.5; scoreSpeed=.9; coinRate=.018; }
  if(l===3){ spawnRate=.05; enemySpeed=6; scoreSpeed=.7; coinRate=.028; }
  if(l===4){ spawnRate=.12; enemySpeed=9; scoreSpeed=.25; coinRate=.045; }

  // Check selected map is unlocked (or free)
  const mapId = mapChoice.value || 'space';
  const mapObj = maps.find(m => m.id === mapId) || maps[0];
  const unlocked = localStorage.getItem('MAP_' + mapObj.id) === '1' || mapObj.price === 0;
  if(!unlocked){
    alert('This map is locked. Unlock it from the store first.');
    // keep menu visible
    return;
  }

  selectedMap = mapId;
  // Check rocket ownership; if not owned, fallback to rocket1
  const rocketSel = rocketChoice.value || 'rocket1';
  const rocketObj = rockets.find(r => r.type === rocketSel);
  if(rocketObj && !rocketObj.owned){
    alert('Selected rocket not owned ‚Äî using default Rocket 1.');
    selectedRocket = 'rocket1';
    rocketChoice.value = 'rocket1';
  } else {
    selectedRocket = rocketSel;
  }

  menu.style.display = 'none';
  canvas.style.display = 'block';
  ctrl.style.display = 'flex';
  gameOverEl.style.display = 'none';
  startGame();
}

function startGame(){
  asteroids = [];
  coinsArr = [];
  powerUps = [];
  score = 0;
  px = W/2;
  moveDir = 0;
  play = true;
  lastScoreCoinBonus = 0;
  lastPowerSpawnScore = 0;
  startCoins = totalCoins;
  // reset effects
  shieldActive = magnetActive = slowActive = false;
  shieldExpires = magnetExpires = slowExpires = 0;
  originalEnemySpeed = null;
  originalSpawnRate = null;
  updateActivePowersLabel();
}

/* ===========================
   Graphics helpers (Option A)
   =========================== */
function drawBackgroundFor(mapId){
  const colors = {space:'#001018', nebula:'#160d2b', mars:'#7c1d1d', jupiter:'#f5b342', galaxy:'#1b1464', blackhole:'#050506'};
  ctx.fillStyle = colors[mapId] || '#000';
  ctx.fillRect(0,0,W,H);

  // twinkling stars
  for(let i=0;i<35;i++){
    const x = (i*97)%W + (i%3)*3;
    const y = (i*53)%H + (i%5)*2;
    const r = (i%4===0) ? 1.8 : 0.9;
    const alpha = 0.45 + 0.55 * Math.abs(Math.sin((Date.now()/500) + i));
    ctx.beginPath();
    ctx.fillStyle = `rgba(255,255,255,${alpha})`;
    ctx.arc((x*1.03)%W, (y*1.07)%H, r, 0, Math.PI*2);
    ctx.fill();
  }
}

function generateAsteroidShape(r){
  const points = 5 + Math.floor(Math.random()*3);
  const angleStep = (Math.PI*2)/points;
  const shape = [];
  for(let i=0;i<points;i++){
    const len = r*(0.7 + Math.random()*0.6);
    shape.push({x:Math.cos(i*angleStep)*len, y:Math.sin(i*angleStep)*len});
  }
  return shape;
}

/* ===========================
   Canvas setup (once)
   =========================== */
function setupCanvas(){
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
setupCanvas();

/* ===========================
   Power-up helpers
   =========================== */
function spawnRandomPowerUp(){
  const types = ['shield','magnet','slow'];
  const type = types[Math.floor(Math.random()*types.length)];
  const x = Math.random()*(W-40)+20;
  const y = -20;
  powerUps.push({type, x, y, vy: 2, taken: false});
}

function applyPower(type){
  const now = Date.now();
  if(type === 'shield'){
    shieldActive = true;
    shieldExpires = Math.max(shieldExpires, now + DURATION.shield);
  } else if(type === 'magnet'){
    magnetActive = true;
    magnetExpires = Math.max(magnetExpires, now + DURATION.magnet);
  } else if(type === 'slow'){
    // store original values
    if(!slowActive){
      originalEnemySpeed = enemySpeed;
      originalSpawnRate = spawnRate;
    }
    slowActive = true;
    slowExpires = Math.max(slowExpires, now + DURATION.slow);
    // apply slow ‚Äî reduce speed & spawn
    enemySpeed = Math.max(1, enemySpeed * 0.5);
    spawnRate = Math.max(0.002, spawnRate * 0.6);
  }
  updateActivePowersLabel();
}

function updateActivePowersLabel(){
  const now = Date.now();
  const active = [];
  if(shieldActive && shieldExpires > now) active.push('Shield');
  if(magnetActive && magnetExpires > now) active.push('Magnet');
  if(slowActive && slowExpires > now) active.push('Slow-Mo');
  activePowersEl.innerText = active.length ? active.join(' ‚Ä¢ ') : 'None';
}

/* ===========================
   Main loop (runs always)
   =========================== */
let coinAngle = 0;
function loop(){
  // draw background
  drawBackgroundFor(selectedMap);

  const now = Date.now();

  // check power expirations
  if(shieldActive && shieldExpires <= now){
    shieldActive = false;
    shieldExpires = 0;
    updateActivePowersLabel();
  }
  if(magnetActive && magnetExpires <= now){
    magnetActive = false;
    magnetExpires = 0;
    updateActivePowersLabel();
  }
  if(slowActive && slowExpires <= now){
    slowActive = false;
    slowExpires = 0;
    // restore speeds
    if(originalEnemySpeed !== null) enemySpeed = originalEnemySpeed;
    if(originalSpawnRate !== null) spawnRate = originalSpawnRate;
    originalEnemySpeed = originalSpawnRate = null;
    updateActivePowersLabel();
  }

  if(play){
    // movement
    px += moveDir * 6;
    // clamp movement
    px = Math.max(20, Math.min(W-20, px));

    // spawn asteroids & coins
    if(Math.random() < spawnRate) {
      const r = 12 + Math.random()*8;
      asteroids.push({
        x: Math.random()*(W-40)+20,
        y: -30,
        r,
        angle: Math.random()*Math.PI*2,
        rotSpeed: (Math.random()-0.5)*0.08,
        shape: generateAsteroidShape(r)
      });
    }
    if(Math.random() < coinRate){
      coinsArr.push({
        x: Math.random()*(W-20)+10,
        y: -20,
        scale: 1,
        opacity: 1,
        collect: false
      });
    }

    // spawn power-up when player reaches next 500 score block
    if(Math.floor(score) - lastPowerSpawnScore >= 500){
      spawnRandomPowerUp();
      lastPowerSpawnScore = Math.floor(score);
    }
  }

  coinAngle += 0.15;

  // update asteroids (iterate backwards for safe splice)
  for(let i = asteroids.length - 1; i >= 0; i--){
    const a = asteroids[i];
    a.y += enemySpeed;
    a.angle += a.rotSpeed;

    // collision (distance-based)
    const dx = a.x - px;
    const dy = a.y - (py + 20);
    const dist = Math.hypot(dx, dy);
    if(dist < a.r + 16 && play){
      if(shieldActive){
        // destroy asteroid and continue
        asteroids.splice(i,1);
        score += 1; // small reward
      } else {
        // collided - game over
        play = false;
        setTimeout(() => {
          // overlay
          gameOverEl.style.display = 'flex';
          gameOverEl.setAttribute('aria-hidden', 'false');
          goScore.innerText = 'Score: ' + Math.floor(score);
          const earned = Math.max(0, totalCoins - startCoins);
          goCoins.innerText = 'Coins Earned: ' + (earned > 0 ? '+'+earned : '0');
          ctrl.style.display = 'none';
          playAgainBtn.focus();
          trapFocus(gameOverEl);
        }, 120);
        break;
      }
    }

    if(a.y > H + 40) asteroids.splice(i,1);
  }

  // update power-ups (falling items)
  for(let i = powerUps.length - 1; i >= 0; i--){
    const p = powerUps[i];
    p.y += p.vy;
    // draw
    ctx.save();
    ctx.beginPath();
    // circle background per type
    if(p.type === 'shield') ctx.fillStyle = '#60a5fa';
    else if(p.type === 'magnet') ctx.fillStyle = '#f59e0b';
    else if(p.type === 'slow') ctx.fillStyle = '#ef4444';
    ctx.globalAlpha = 0.95;
    ctx.arc(p.x, p.y, 12, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
    // letter
    ctx.fillStyle = '#011827';
    ctx.font = '12px system-ui';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const letter = p.type === 'shield' ? 'S' : (p.type === 'magnet' ? 'M' : 'T');
    ctx.fillText(letter, p.x, p.y);
    ctx.restore();

    // collision with player
    if(!p.taken && Math.abs(p.x - px) < 18 && Math.abs(p.y - (py + 20)) < 22 && play){
      p.taken = true;
      applyPower(p.type);
      // remove from list
      powerUps.splice(i,1);
      continue;
    }
    // remove if off-screen
    if(p.y > H + 30) powerUps.splice(i,1);
  }

  // update coins
  for(let i = coinsArr.length - 1; i >= 0; i--){
    const c = coinsArr[i];
    if(!c.collect && Math.abs(c.x - px) < 16 && Math.abs(c.y - (py + 20)) < 20 && play){
      c.collect = true;
      const multiplier = (rockets.find(r=>r.type===selectedRocket) || rockets[0]).multiplier;
      totalCoins += multiplier;
      localStorage.setItem('TOTAL_COINS', totalCoins);
      c.vy = -2; // upward movement when collected
      updateCoinsUI();
    }
    if(c.collect){
      c.scale += 0.06;
      c.opacity -= 0.06;
      c.y += (c.vy || 0);
      if(c.opacity <= 0){
        coinsArr.splice(i,1);
        continue;
      }
    } else {
      // if magnet active, attract coins toward player
      if(magnetActive){
        const ax = px - c.x;
        const ay = (py+20) - c.y;
        const dist = Math.hypot(ax, ay) || 1;
        // apply small attraction velocity
        c.x += (ax / dist) * 1.8;
        c.y += (ay / dist) * 1.8;
      } else {
        c.y += 3;
      }
      if(c.y > H + 20) coinsArr.splice(i,1);
    }
  }

  // draw coins
  for(const c of coinsArr){
    ctx.save();
    ctx.translate(c.x, c.y);
    ctx.rotate(coinAngle);
    ctx.scale(c.scale, c.scale);
    ctx.globalAlpha = c.opacity;
    // coin body
    ctx.beginPath();
    ctx.arc(0,0,6,0,Math.PI*2);
    ctx.fillStyle = 'gold';
    ctx.fill();
    // inner detail
    ctx.globalAlpha = (c.opacity + 1) / 2;
    ctx.fillStyle = '#ffd54a';
    ctx.fillRect(-2,-3,4,6);
    ctx.restore();
    ctx.globalAlpha = 1;
  }

  // draw asteroids (shapes)
  for(const a of asteroids){
    ctx.save();
    ctx.translate(a.x, a.y);
    ctx.rotate(a.angle);
    ctx.beginPath();
    ctx.fillStyle = '#9aa4b2';
    ctx.moveTo(a.shape[0].x, a.shape[0].y);
    for(let j=1;j<a.shape.length;j++) ctx.lineTo(a.shape[j].x, a.shape[j].y);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  // draw player rocket
  const rColor = (rockets.find(r=>r.type===selectedRocket) || rockets[0]).color;
  ctx.save();
  ctx.beginPath();
  ctx.fillStyle = rColor;
  ctx.moveTo(px, py);
  ctx.lineTo(px - 15, py + 35);
  ctx.lineTo(px + 15, py + 35);
  ctx.closePath();
  ctx.fill();

  // flame
  const flameHeight = 6 + 2*Math.sin(Date.now()/100);
  ctx.fillStyle = 'orange';
  ctx.beginPath();
  ctx.moveTo(px - 3, py + 35);
  ctx.lineTo(px + 3, py + 35);
  ctx.lineTo(px, py + 35 + flameHeight);
  ctx.closePath();
  ctx.fill();
  ctx.restore();

  // draw shield visual if active
  if(shieldActive){
    const t = Math.max(0, (shieldExpires - now) / DURATION.shield);
    ctx.save();
    ctx.beginPath();
    ctx.strokeStyle = `rgba(96,165,250,${0.6 + 0.4 * t})`;
    ctx.lineWidth = 3;
    ctx.arc(px, py + 12, 28, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }

  // HUD / score update
  document.getElementById('score').innerText = 'Score: ' + Math.floor(score);
  document.getElementById('coins').innerText = totalCoins;
  menuCoins.innerText = totalCoins;

  // score & 100-score coin bonus
  if(play) score += scoreSpeed;
  const scoreHundreds = Math.floor(score / 100);
  if(scoreHundreds > lastScoreCoinBonus){
    const diff = scoreHundreds - lastScoreCoinBonus;
    totalCoins += 5 * diff; // +5 coins per 100 score
    if(totalCoins < 0) totalCoins = 0;
    localStorage.setItem('TOTAL_COINS', totalCoins);
    lastScoreCoinBonus = scoreHundreds;
    updateCoinsUI();
  }

  requestAnimationFrame(loop);
}
loop(); // start loop once

/* ===========================
   Play Again / Back to Menu
   =========================== */
playAgainBtn.addEventListener('click', () => {
  // hide overlay
  gameOverEl.style.display = 'none';
  gameOverEl.setAttribute('aria-hidden', 'true');
  releaseFocusTrap();

  // show canvas & controls
  menu.style.display = 'none';
  canvas.style.display = 'block';
  ctrl.style.display = 'flex';

  // reset and start
  startGame();
});

backMenuBtn.addEventListener('click', () => {
  gameOverEl.style.display = 'none';
  gameOverEl.setAttribute('aria-hidden', 'true');
  releaseFocusTrap();

  canvas.style.display = 'none';
  ctrl.style.display = 'none';
  menu.style.display = 'block';
});

/* ===========================
   Accessibility: focus trap for dialog
   =========================== */
let previousActive = null;
function trapFocus(el){
  previousActive = document.activeElement;
  const focusable = el.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
  if(focusable.length === 0) return;
  const first = focusable[0];
  const last = focusable[focusable.length - 1];

  function handleKey(e){
    if(e.key === 'Tab'){
      if(e.shiftKey){
        if(document.activeElement === first){
          e.preventDefault();
          last.focus();
        }
      } else {
        if(document.activeElement === last){
          e.preventDefault();
          first.focus();
        }
      }
    }
    if(e.key === 'Escape'){
      // close dialog (back to menu)
      backMenuBtn.click();
    }
  }
  el._handleKey = handleKey;
  document.addEventListener('keydown', handleKey);
}

function releaseFocusTrap(){
  if(gameOverEl._handleKey) document.removeEventListener('keydown', gameOverEl._handleKey);
  if(previousActive) previousActive.focus();
  previousActive = null;
}

/* expose for markup */
window.setDiff = setDiff;
window.buyRocket = buyRocket;
window.buyMap = buyMap;
window.redeemCode = redeemCode;
</script>
</body>
</html>